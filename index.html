<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Management - Split View Layout</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; background-color: #f4f7f9; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* 顶部标题栏 */
        .header-bar { flex: 0 0 auto; margin-bottom: 20px; }

        /* 主容器：改为 Flex 布局，撑满剩余高度 */
        .main-wrapper { 
            display: flex; 
            gap: 20px; 
            flex: 1; 
            overflow: hidden; /* 防止主容器滚动，让内部各自滚动 */
        }
        
        /* --- 左侧：树形列表 --- */
        .tree-container { 
            width: 400px; /* 给定一个初始宽度，或者使用 flex: 0 0 30% */
            flex-shrink: 0; 
            background: white; 
            border-radius: 8px; 
            border: 1px solid #dee2e6; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
            transition: width 0.3s ease;
        }

        /* 只有当右侧面板隐藏时，左侧才撑满（可选，看你喜好） */
        .tree-container.full-width {
            flex: 1;
            width: 100%;
        }

        .tree-content { overflow-y: auto; flex: 1; } /* 内部滚动 */
        
        .tree-row { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #eee; transition: background 0.2s; cursor: default; }
        .tree-row:hover { background-color: #f8f9fa; }
        .tree-row.row-locked { background-color: #f9f9f9; }
        .tree-row.row-locked .select-item, .tree-row.row-locked .badge, .tree-row.row-locked span { opacity: 0.3; }
        
        .level-stock, .level-index { font-weight: bold; }
        .level-chain { padding-left: 40px; border-left: 4px solid #0d6efd; background: #fcfdfe; }
        .level-option { padding-left: 80px; border-left: 4px solid #6c757d; }
        .toggle-btn { width: 24px; height: 24px; border: 1px solid #ccc; background: #fff; border-radius: 4px; margin-right: 10px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }

        /* --- 右侧：编辑面板 (原 Offcanvas) --- */
        .edit-panel-container {
            flex: 1; /* 占据剩余空间 */
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: none; /* 默认隐藏 */
            flex-direction: column;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }
        
        .edit-panel-container.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .edit-panel-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .edit-panel-body { flex: 1; overflow-y: auto; padding: 20px; background: #fafbfc; }
        .edit-panel-footer { padding: 15px; border-top: 1px solid #dee2e6; background: white; text-align: right; }

        /* 模块卡片样式微调 */
        .module-card { background: #fff; border: 1px solid #e0e6ed; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .module-header { background: #fff; padding: 10px 15px; border-bottom: 1px solid #f0f0f0; font-weight: 600; color: #333; }
        .attr-item { display: flex; padding: 12px 15px; border-bottom: 1px solid #f5f5f5; align-items: flex-start; }
        .attr-content { flex: 1; margin-left: 15px; opacity: 0.5; pointer-events: none; }
        .attr-item.active { background-color: #f0f7ff; } /* 激活时高亮更明显 */
        .attr-item.active .attr-content { opacity: 1; pointer-events: auto; }

        /* --- 确认弹窗 (保持 Modal 逻辑) --- */
        .confirm-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;
        }
        .confirm-modal-overlay.show { display: flex; }
        .confirm-modal-container { width: 500px; background: #fff; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 90vh; }
        .confirm-modal-content { padding: 20px; overflow-y: auto; }
        .confirm-modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: bold; background: #f9f9f9; display: flex; align-items: center; }
        .confirm-modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; background: #f9f9f9; }
        
        /* 表格和输入框样式保持一致 */
        .change-list { width: 100%; margin-bottom: 15px; }
        .change-list td { padding: 8px 0; border-bottom: 1px solid #eee; }
        .target-value { font-family: monospace; background: #e6f7ff; color: #1890ff; padding: 2px 6px; border-radius: 4px; }
        .edit-reason-input { width: 100%; min-height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-top: 10px; }
        
    </style>
</head>
<body>

<div class="container-fluid header-bar">
    <div class="d-flex justify-content-between align-items-center">
        <h4><i class="bi bi-shield-lock"></i> Security Master: Professional View</h4>
        <button class="btn btn-primary shadow-sm" id="bulkEditBtn" disabled>
            <i class="bi bi-layout-sidebar-reverse"></i> Open Bulk Editor
        </button>
    </div>
</div>

<div class="container-fluid main-wrapper">
    
    <div class="tree-container full-width" id="treeContainer">
        <div class="p-3 border-bottom bg-light d-flex justify-content-between">
            <span class="fw-bold text-secondary">Asset Navigator</span>
            <span class="badge bg-secondary" id="treeCountBadge">3 Items</span>
        </div>
        <div class="tree-content">
            <div class="tree-row level-stock" data-id="s1" data-level="Equity" data-name="AAPL">
                <button class="toggle-btn" onclick="toggle('c_s1')">-</button>
                <input type="checkbox" class="form-check-input select-item me-3">
                <span class="badge bg-primary badge-type me-2">EQUITY</span> AAPL
            </div>
            <div id="c_s1" class="collapse show">
                <div class="tree-row level-chain" data-id="ch1" data-level="Chain" data-name="AAPL Chain">
                    <button class="toggle-btn" onclick="toggle('o_ch1')">+</button>
                    <input type="checkbox" class="form-check-input select-item me-3">
                    <span class="badge bg-info text-dark badge-type me-2">CHAIN</span> 1AAPL
                </div>
                <div id="o_ch1" class="collapse">
                    <div class="tree-row level-option" data-id="op1" data-level="Option" data-name="AAPL 150C">
                        <input type="checkbox" class="form-check-input select-item me-3">
                        <span class="badge bg-secondary badge-type me-2">OPTION</span> 1AAPL 150C
                    </div>
                </div>
            </div>
            <div class="tree-row level-index" data-id="i1" data-level="Index" data-name="SPX">
                <button class="toggle-btn" onclick="toggle('c_i1')">-</button>
                <input type="checkbox" class="form-check-input select-item me-3">
                <span class="badge bg-success badge-type me-2">INDEX</span> SPX
            </div>
        </div>
    </div>

    <div class="edit-panel-container shadow-sm" id="editPanel">
        <div class="edit-panel-header">
            <div>
                <i class="bi bi-pencil-square text-primary me-2"></i>
                Bulk Editing: <span id="currentTypeLabel" class="fw-bold text-dark"></span>
            </div>
            <button type="button" class="btn-close" onclick="closeEditPanel()"></button>
        </div>
        
        <div class="edit-panel-body">
            <div id="selectedSummary" class="alert alert-info py-2 small mb-3">
                <i class="bi bi-info-circle me-1"></i> Select attributes below to apply changes.
            </div>
            <form id="editForm">
                <div id="fields-container">
                    </div>
            </form>
        </div>

        <div class="edit-panel-footer">
            <span class="text-muted small me-3 float-start mt-2">* Check box to activate field</span>
            <button type="button" class="btn btn-outline-secondary me-2" onclick="closeEditPanel()">Close</button>
            <button type="button" class="btn btn-primary" onclick="showConfirmModal()">Apply Changes</button>
        </div>
    </div>

</div>

<div class="confirm-modal-overlay" id="confirmModalOverlay">
    <div class="confirm-modal-container">
        <div class="confirm-modal-header text-warning">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> Confirm Operations
        </div>
        
        <div class="confirm-modal-content">
            <div class="alert alert-warning py-2 mb-3">
                You are updating <strong id="confirmCount">0</strong> items of type <strong id="confirmType"></strong>.
            </div>

            <table class="change-list">
                <thead>
                    <tr class="text-secondary small">
                        <th>ATTRIBUTE</th>
                        <th>NEW VALUE</th>
                    </tr>
                </thead>
                <tbody id="changeListBody"></tbody>
            </table>

            <div class="mt-3">
                <label class="fw-bold small mb-1">Edit Reason <span class="text-danger">*</span></label>
                <textarea 
                    class="edit-reason-input" 
                    placeholder="Please explain why you are making these changes..."
                    id="editReason"
                    oninput="updateCharCount()"
                ></textarea>
                <div class="text-end text-muted small mt-1"><span id="charCount">0</span>/500</div>
            </div>
        </div>

        <div class="confirm-modal-footer">
            <button class="btn btn-light border" onclick="hideConfirmModal()">Cancel</button>
            <button class="btn btn-primary ms-2" id="confirmBtn" disabled onclick="handleConfirm()">Confirm Execution</button>
        </div>
    </div>
</div>

<div id="templates" style="display:none">
    <div id="tpl-equity">
        <div class="module-card">
            <div class="module-header"><i class="bi bi-graph-up-arrow"></i> Trading</div>
                <div class="attr-item d-flex align-items-center mb-2">
                    <input type="checkbox" class="form-check-input attr-checkbox me-3" id="activate-tradable">
                    
                    <div class="attr-content d-flex justify-content-between align-items-center flex-grow-1">
                        <label class="attr-label mb-0" for="activate-tradable">Tradable</label>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-tradable" >
                            <label class="form-check-label" for="switch-tradable"></label>
                        </div>
                    </div>
                </div>

                <div class="attr-item d-flex align-items-center">
                    <input type="checkbox" class="form-check-input attr-checkbox me-3" id="activate-closing">
                    
                    <div class="attr-content d-flex justify-content-between align-items-center flex-grow-1">
                        <label class="attr-label mb-0" for="activate-closing">Closing Only</label>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-closing" >
                            <label class="form-check-label" for="switch-closing"></label>
                        </div>
                    </div>
                </div>

    
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Trading Session</label>
                    <div class="d-flex gap-2 mt-1">
                        <div class="form-check"><input class="form-check-input" type="checkbox" > <small>RTH</small></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox"> <small>Pre/Post</small></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox"> <small>Overnight</small></div>
                    </div>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Order Type</label>
                    <div class="d-flex gap-2 mt-1">
                        <div class="form-check"><input class="form-check-input" type="checkbox" > <small>Market</small></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox"> <small>Limit</small></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox"> <small>MOC</small></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="module-card">
            <div class="module-header"><i class="bi bi-pie-chart"></i> Fractional Setting</div>
            <div class="attr-item" id="fractional-master">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Eligible (Y/N)</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="eligSwitch" onchange="toggleFractionalSub(this.checked)">
                    </div>
                    <div id="fractional-subs" class="mt-3 ps-2 border-start border-2" style="opacity: 0.5; pointer-events: none;">
                        <div class="mb-2">
                            <small class="text-muted">Threshold (Mid/High)</small>
                            <div class="d-flex gap-2"><input type="number" class="form-control form-control-sm" value="1"><input type="number" class="form-control form-control-sm" value="2"></div>
                        </div>
                        <div>
                            <small class="text-muted">Decimals (1-4)</small>
                            <select class="form-select form-select-sm"><option>1</option><option>2</option><option>3</option><option>4</option></select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="module-card">
            <div class="module-header"><i class="bi bi-speedometer2"></i> ADV Threshold</div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">ADV Days</label>
                    <select class="form-select form-select-sm"><option>1</option><option selected>30</option><option>60</option><option>90</option><option>120</option></select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">ADV Percentage</label>
                    <div class="input-group input-group-sm"><input type="number" class="form-control" placeholder="Input %"><span class="input-group-text">%</span></div>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Alert Level</label>
                    <select class="form-select form-select-sm"><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
                </div>
            </div>
        </div>

        <div class="module-card">
            <div class="module-header"><i class="bi bi-diagram-3"></i> Routing</div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Routing Group</label>
                    <select class="form-select form-select-sm"><option>Group A</option><option>Group B</option></select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Option Group</label>
                    <select class="form-select form-select-sm"><option>OG_01</option><option>OG_02</option></select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Complex Group</label>
                    <select class="form-select form-select-sm"><option>OG_01</option><option>OG_02</option></select>
                </div>
            </div>
        </div>
    </div>
    <div id="tpl-index">
        <div class="module-card">
            <div class="module-header"><i class="bi bi-diagram-3"></i> Routing</div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Routing Group</label>
                    <select class="form-select form-select-sm"><option>Group A</option><option>Group B</option></select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Option Group</label>
                    <select class="form-select form-select-sm"><option>OG_01</option><option>OG_02</option></select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Complex Group</label>
                    <select class="form-select form-select-sm"><option>OG_01</option><option>OG_02</option></select>
                </div>
            </div>
        </div>
    </div>
    <div id="tpl-chain">
        <div class="attr-item d-flex align-items-center mb-2">
                    <input type="checkbox" class="form-check-input attr-checkbox me-3" id="activate-tradable">
                    
                    <div class="attr-content d-flex justify-content-between align-items-center flex-grow-1">
                        <label class="attr-label mb-0" for="activate-tradable">Chain Tradable</label>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-tradable" >
                            <label class="form-check-label" for="switch-tradable"></label>
                        </div>
                    </div>
                </div>

                <div class="attr-item d-flex align-items-center">
                    <input type="checkbox" class="form-check-input attr-checkbox me-3" id="activate-closing">
                    
                    <div class="attr-content d-flex justify-content-between align-items-center flex-grow-1">
                        <label class="attr-label mb-0" for="activate-closing">Chain Closing Only</label>
                        
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="switch-closing" >
                            <label class="form-check-label" for="switch-closing"></label>
                        </div>
                    </div>
                </div>

    </div>

    <div id="tpl-option">
        <div class="module-card">
            <div class="module-header"><i class="bi bi-file-earmark-binary"></i> Option Trading</div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Tradable</label>
                    <select class="form-select form-select-sm">
                        <option>On</option><option>Off</option>
                        <option class="text-primary fw-bold">Following Chain</option>
                    </select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Closing Only</label>
                    <select class="form-select form-select-sm">
                        <option>On</option><option>Off</option>
                        <option class="text-primary fw-bold">Following Chain</option>
                    </select>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Trading Session</label>
                    <div class="d-flex gap-2 mt-1">
                        <div class="form-check"><input class="form-check-input" type="checkbox" > <small>RTH</small></div>
                    </div>
                </div>
            </div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Order Type</label>
                    <div class="d-flex gap-2 mt-1">
                        <div class="form-check"><input class="form-check-input" type="checkbox" checked> <small>Market</small></div>
                        <div class="form-check"><input class="form-check-input" type="checkbox"> <small>Limit</small></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="module-card">
            <div class="module-header"><i class="bi bi-geo"></i> Routing</div>
            <div class="attr-item">
                <input type="checkbox" class="form-check-input attr-checkbox">
                <div class="attr-content">
                    <label class="attr-label">Routing Group</label>
                    <input type="text" class="form-control form-control-sm" placeholder="Search Routing ID (e.g. RG_001)">
                </div>
            </div>
        </div>
    </div>
    </div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let selectedLevel = null;
    let selectedCount = 0;

    function toggle(id) { 
        document.getElementById(id).classList.toggle('show'); 
    }

    // 复选框逻辑
    document.querySelectorAll('.select-item').forEach(cb => {
        cb.addEventListener('change', function() {
            const row = this.closest('.tree-row');
            const level = row.dataset.level;
            
            if (this.checked) {
                if (!selectedLevel) selectedLevel = level;
                selectedCount++;
            } else {
                selectedCount--;
                if (selectedCount === 0) selectedLevel = null;
            }
            updateUIState();
        });
    });

    function updateUIState() {
        // 锁定逻辑
        document.querySelectorAll('.tree-row').forEach(row => {
            const checkbox = row.querySelector('.select-item');
            if (selectedLevel && row.dataset.level !== selectedLevel) {
                row.classList.add('row-locked');
                checkbox.disabled = true;
            } else {
                row.classList.remove('row-locked');
                checkbox.disabled = false;
            }
        });

        // 按钮状态
        const btn = document.getElementById('bulkEditBtn');
        btn.disabled = selectedCount === 0;
        btn.innerHTML = selectedCount > 0 
            ? `<i class="bi bi-pencil-square"></i> Edit ${selectedCount} ${selectedLevel}(s)` 
            : `<i class="bi bi-layout-sidebar-reverse"></i> Open Bulk Editor`;
    }

    // 打开编辑面板 (核心布局切换逻辑)
    document.getElementById('bulkEditBtn').addEventListener('click', () => {
        const treeContainer = document.getElementById('treeContainer');
        const editPanel = document.getElementById('editPanel');
        const container = document.getElementById('fields-container');

        // 1. 设置内容
        document.getElementById('currentTypeLabel').innerText = selectedLevel;
        document.getElementById('selectedSummary').innerHTML = `You are editing <strong>${selectedCount}</strong> items of type <strong>${selectedLevel}</strong>.`;
        
        // 简化的模板渲染 (示例只针对 Equity，实际逻辑同前)
        const tplId = 'tpl-equity'; // 实际应根据 selectedLevel 动态获取
        const tplContent = document.getElementById(tplId) ? document.getElementById(tplId).innerHTML : '<div class="p-3 text-muted">No template for this type</div>';
        container.innerHTML = tplContent;

        // 绑定激活逻辑
        container.querySelectorAll('.attr-checkbox').forEach(chk => {
            chk.addEventListener('change', function() {
                const parent = this.closest('.attr-item');
                if(this.checked) parent.classList.add('active');
                else parent.classList.remove('active');
            });
        });

        // 2. 切换布局样式
        treeContainer.classList.remove('full-width'); // 左侧收缩
        editPanel.classList.add('active'); // 右侧显示
    });

    // 关闭面板
    function closeEditPanel() {
        document.getElementById('editPanel').classList.remove('active');
        document.getElementById('treeContainer').classList.add('full-width');
    }

    // 确认弹窗逻辑 (原生 JS 实现)
    function showConfirmModal() {
        const activeItems = document.querySelectorAll('.attr-item.active');
        if (activeItems.length === 0) {
            alert('Please select at least one attribute to change.');
            return;
        }

        // 填充数据
        document.getElementById('confirmCount').innerText = selectedCount;
        document.getElementById('confirmType').innerText = selectedLevel;
        
        const tbody = document.getElementById('changeListBody');
        tbody.innerHTML = '';
        activeItems.forEach(item => {
            const label = item.querySelector('label').innerText;
            // 简单取值逻辑
            const val = "Active / On"; 
            tbody.innerHTML += `<tr><td>${label}</td><td><span class="target-value">${val}</span></td></tr>`;
        });

        document.getElementById('editReason').value = ''; // 清空输入
        document.getElementById('confirmBtn').disabled = true;
        
        // 显示覆盖层
        document.getElementById('confirmModalOverlay').classList.add('show');
    }

    function hideConfirmModal() {
        document.getElementById('confirmModalOverlay').classList.remove('show');
    }

    function updateCharCount() {
        const val = document.getElementById('editReason').value;
        document.getElementById('charCount').innerText = val.length;
        document.getElementById('confirmBtn').disabled = val.length === 0;
    }

    function handleConfirm() {
        alert('Submitted successfully!');
        hideConfirmModal();
        closeEditPanel();
        // 重置选择逻辑...
    }

</script>
</body>
</html>
